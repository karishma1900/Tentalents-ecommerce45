generator client {
  provider = "prisma-client-js"
  output   = "../generated/coupon-service"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum CouponType {
  FLAT // Fixed amount (e.g., ₹100 off)
  PERCENTAGE // Percentage-based (e.g., 10% off)
}

enum CouponScope {
  GLOBAL // Can be used platform-wide
  PRODUCT // Valid only for specific products
  CATEGORY // Valid on specific product categories
  VENDOR // Vendor-specific coupon
  USER // User-specific personal coupon
}

model Coupon {
  id            String      @id @default(uuid())
  code          String      @unique // Unique coupon code (e.g., SAVE10)
  type          CouponType
  scope         CouponScope
  value         Decimal // Discount value (₹ or %)
  maxDiscount   Decimal? // Cap for percentage discounts (optional)
  minOrderValue Decimal? // Minimum cart value to apply coupon (optional)
  usageLimit    Int? // Max total redemptions (e.g., 100 uses)
  perUserLimit  Int? // Max times one user can redeem
  startDate     DateTime // Coupon valid from
  endDate       DateTime // Coupon valid till
  isActive      Boolean     @default(true)
  createdAt     DateTime    @default(now())

  redemptions CouponRedemption[]
}

model CouponRedemption {
  id         String   @id @default(uuid())
  couponId   String
  userId     String // User who used it
  orderId    String // Order where coupon was used
  redeemedAt DateTime @default(now())

  coupon Coupon @relation(fields: [couponId], references: [id])

  @@unique([couponId, userId, orderId]) // Prevent duplicate redemptions
  @@index([userId])
}
